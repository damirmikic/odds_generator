<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odds Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* --- Base Input Styling --- */
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #475569;
            font-weight: 500;
            font-size: 0.875rem;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #f9fafb;
            color: #1f2937;
        }
        .input-group input:disabled, .input-group select:disabled {
             background-color: #e5e7eb;
             cursor: not-allowed;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        /* --- Player Card --- */
        .player-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #ffffff;
            position: relative;
            transition: box-shadow 0.2s;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        .player-card h4 {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #f3f4f6;
            margin-bottom: 1rem;
        }

        /* --- Autocomplete & Utils --- */
        .input-wrapper { position: relative; }
        .calc-btn {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background-color: #e5e7eb;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4b5563;
            transition: all 0.2s ease;
        }
        .calc-btn:hover { background-color: #d1d5db; color: #1f2937; }
        .remove-preview-row {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fecaca;
            border-radius: 9999px;
            width: 1.5rem;
            height: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .remove-preview-row:hover {
            background-color: #ef4444;
            color: white;
            border-color: #ef4444;
        }
        .autocomplete-suggestions {
            position: absolute;
            border: 1px solid #e5e7eb;
            background-color: white;
            z-index: 99;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .autocomplete-suggestions div { padding: 0.75rem; cursor: pointer; }
        .autocomplete-suggestions div:hover { background-color: #f3f4f6; }
        .autocomplete-suggestions .highlight { font-weight: bold; color: #1e293b; }

        /* --- Status Indicator --- */
        @keyframes pulse-green { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .pulse-green { animation: pulse-green 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulse-red { animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        /* --- Action Buttons --- */
        .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 700;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            transition: all 0.2s ease-in-out;
            transform: translateY(0);
        }
        .action-btn:hover {
             box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
             transform: translateY(-2px);
        }
        .action-btn:focus {
            outline: none;
        }
        .action-btn.primary {
            background-image: linear-gradient(to right, #3b82f6, #2563eb);
            color: white;
        }
        .action-btn.primary:focus-visible {
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
        }
         .action-btn.primary:disabled {
            background-image: none;
            background-color: #93c5fd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .action-btn.secondary {
            background-color: #4b5563;
            color: white;
        }
         .action-btn.secondary:hover {
            background-color: #374151;
        }
        .action-btn.secondary:focus-visible {
            box-shadow: 0 0 0 4px rgba(75, 85, 99, 0.4);
        }
        .action-btn.success {
            background-image: linear-gradient(to right, #22c55e, #16a34a);
            color: white;
        }
         .action-btn.success:hover {
            opacity: 0.9;
        }
         .action-btn.success:focus-visible {
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.4);
        }

    </style>
</head>
<body class="bg-gray-100 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="max-w-6xl mx-auto bg-white rounded-xl border border-slate-200 shadow-sm p-6 sm:p-8">
            <header class="flex items-center justify-between mb-8 border-b border-slate-200 pb-6">
                 <div class="flex items-center gap-4">
                    <div class="bg-blue-100 text-blue-600 p-3 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calculator"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x1="16" y1="14" y2="18"/><line x1="16" x1="12" y1="14" y2="14"/><line x1="12" x1="12" y1="14" y2="18"/><line x1="8" x1="8" y1="10" y2="18"/><line x1="8" x1="12" y1="10" y2="10"/></svg>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-slate-800">Generator Kvota</h1>
                 </div>
                 <div id="status-container" class="flex items-center gap-2.5 text-sm font-medium">
                    <div id="status-indicator" class="w-2.5 h-2.5 rounded-full bg-red-500 pulse-red" title="Status učitavanja baze podataka"></div>
                    <span id="status-text" class="text-slate-500">Učitavanje...</span>
                 </div>
            </header>

            <form id="odds-form">
                <section id="api-section" class="mb-8 p-6 bg-slate-50 border border-slate-200 rounded-lg">
                    <h3 class="font-bold text-lg text-slate-800 mb-4">Preuzimanje Podataka sa API-ja</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-4">
                            <button type="button" id="fetch-api-btn" class="w-full md:w-auto action-btn secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                <span id="api-btn-text">Učitaj Mečeve sa API-ja</span>
                            </button>
                            <p id="api-status" class="text-sm text-slate-500 mt-2 h-5"></p>
                        </div>
                        <div class="input-group">
                            <label for="competition-select">Takmičenje</label>
                            <select id="competition-select" disabled></select>
                        </div>
                        <div class="input-group md:col-span-2">
                            <label for="event-select">Meč</label>
                            <select id="event-select" disabled></select>
                        </div>
                        <div class="input-group">
                            <label for="team-select">Tim</label>
                            <select id="team-select" disabled></select>
                        </div>
                    </div>
                </section>

                <section class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-8">
                    <div class="input-group lg:col-span-2"><label for="match-name">Naziv Utakmice</label><input type="text" id="match-name"></div>
                    <div class="input-group"><label for="kickoff-date">Datum početka</label><input type="date" id="kickoff-date"></div>
                    <div class="input-group"><label for="kickoff-time">Vreme početka</label><input type="time" id="kickoff-time"></div>
                    <div class="input-group"><label for="team-win-odd">Kvota na Pobedu</label><input type="number" id="team-win-odd" step="0.01" value="1.85"></div>
                    <div class="input-group"><label for="correlation-factor" class="text-xs sm:text-sm">Faktor Kor. (Gol/Pobeda)</label><input type="number" id="correlation-factor" step="0.1" value="1.3"></div>
                    <div class="input-group"><label for="bookmaker-margin">Margina (%)</label><input type="number" id="bookmaker-margin" step="0.1" value="10"></div>
                </section>
                <section class="border-t border-slate-200 pt-8">
                    <div id="players-section-header" class="flex flex-wrap justify-between items-end gap-4 mb-6">
                        <h3 class="text-xl font-bold text-slate-700 w-full sm:w-auto">Igrači</h3>
                        <div class="flex flex-col sm:flex-row gap-4 w-full sm:w-auto">
                            <!-- New API Player Adder -->
                            <div id="api-player-adder" class="flex items-end gap-2 hidden">
                                 <div class="input-group flex-grow">
                                    <label for="api-player-select">Dodaj igrača iz ponude</label>
                                    <select id="api-player-select"></select>
                                 </div>
                                 <button type="button" id="add-api-player-btn" class="h-10 px-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md transition-all transform hover:scale-105 flex-shrink-0" title="Dodaj izabranog igrača">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                 </button>
                            </div>
                            <!-- Manual Filter -->
                            <div class="input-group max-w-xs">
                                <label for="team-filter">Filtriraj po Ekipi (iz baze)</label>
                                <select id="team-filter"></select>
                            </div>
                        </div>
                    </div>
                    <div id="players-container" class="space-y-6"></div>
                </section>
                <div class="flex justify-center mt-6 mb-8"><button type="button" id="add-player-btn" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all transform hover:scale-105"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Dodaj Igrača Ručno</button></div>
            </form>

            <div class="flex flex-col md:flex-row justify-center items-center gap-4 my-8">
                <button id="generate-btn" class="w-full md:w-auto action-btn primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-zap"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                    <span id="generate-btn-text">Generiši Kvote</span>
                </button>
                <button type="button" id="reset-btn" class="w-full md:w-auto action-btn secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw"><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 1 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path></svg>
                    Poništi Unos
                </button>
            </div>

            <div id="preview-section" class="hidden">
                <h2 class="text-xl sm:text-2xl font-bold text-slate-800 mb-6 text-center">Pregled Generisanih Kvota</h2>
                <div class="overflow-x-auto rounded-lg border border-slate-200">
                    <table class="min-w-full">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Igrač</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Opis 1</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Opis 2</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Kvota</th>
                                <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Ukloni</th>
                            </tr>
                        </thead>
                        <tbody id="preview-table-body" class="bg-white"></tbody>
                    </table>
                </div>
                <div class="flex justify-center mt-8">
                    <button id="download-csv-btn" class="w-full md:w-auto action-btn success">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download-cloud"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"></path><path d="M12 12v9"></path><path d="m8 17 4 4 4-4"></path></svg>
                        Preuzmi CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const $ = (selector) => document.querySelector(selector);
        const on = (element, event, handler) => element.addEventListener(event, handler);
        
        // DOM Element Constants
        const generateBtn = $('#generate-btn');
        const downloadCsvBtn = $('#download-csv-btn');
        const addPlayerBtn = $('#add-player-btn');
        const resetBtn = $('#reset-btn');
        const playersContainer = $('#players-container');
        const previewSection = $('#preview-section');
        const previewTableBody = $('#preview-table-body');
        const teamFilter = $('#team-filter');
        const fetchApiBtn = $('#fetch-api-btn');
        const apiBtnText = $('#api-btn-text');
        const apiStatus = $('#api-status');
        const competitionSelect = $('#competition-select');
        const eventSelect = $('#event-select');
        const teamSelect = $('#team-select');
        const apiPlayerAdder = $('#api-player-adder');
        const apiPlayerSelect = $('#api-player-select');
        const addApiPlayerBtn = $('#add-api-player-btn');
        
        // Global State
        let playerCounter = 0;
        let allFbrefStats = [];
        let apiEvents = [];
        let availableApiPlayers = [];

        // --- Math & Stat Helpers ---
        const factorial = n => { if (n < 0) return NaN; if (n === 0) return 1; let r = 1; for (let i = 2; i <= n; i++) r *= i; return r; };
        const poissonProbability = (l, k) => (l < 0) ? 0 : (Math.pow(l, k) * Math.exp(-l)) / factorial(k);
        const probToOdd = p => (p <= 0 || p >= 1) ? null : 1 / p;
        const oddToProb = o => (o <= 1) ? 1 : 1 / o;
        const getLambdaFromProb = p => (p <= 0 || p >= 1) ? 0 : -Math.log(1 - p);
        
        const get24hTime = (date = new Date()) => {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        };
        
        const formatOdd = (o) => {
            if (o === null) return 'N/A';
            if (o <= 1) return '1.01';

            let roundedOdd;
            if (o >= 10) {
                roundedOdd = Math.round(o * 4) / 4;
            } else {
                roundedOdd = Math.round(o * 10) / 10;
            }
            return roundedOdd.toFixed(2);
        };

        const poissonCDF = (lambda, k) => {
            let sum = 0;
            for (let i = 0; i <= k; i++) {
                sum += poissonProbability(lambda, i);
            }
            return sum;
        };
        const applyMarginToOdd = (odd, margin) => {
            if (!odd || margin <= 0 || odd <= 1) return odd;
            const p = 1 / odd;
            const ap = p * (1 + (margin / 100));
            return probToOdd(ap);
        }
        
        const parsePlayerNameFromOutcome = (outcome) => {
            if (!outcome || !outcome.startsWith('player=')) return 'Unknown Player';
            let namePart = outcome.split('=')[1];
            const firstHyphenIndex = namePart.indexOf('-');
            if (firstHyphenIndex === -1) return 'Unknown Player';
            namePart = namePart.substring(firstHyphenIndex + 1);
            return namePart.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        };


        // --- Player Card Management ---
        const createShotLineHTML = (threshold, odd, isCustom = false) => {
            const thresholdInput = isCustom 
                ? `<input type="number" class="shots-threshold w-full" value="${threshold || 1}" min="1" step="1">`
                : `<span class="font-medium text-slate-700">${threshold}+</span>`;
            
            const calcButton = isCustom 
                ? `<button type="button" class="calc-btn calc-shot-btn" title="Izračunaj kvotu za ovu granicu">&#9924;</button>`
                : '';

            return `
            <div class="grid grid-cols-12 gap-x-3 items-center shot-line" data-threshold="${threshold}">
                 <div class="input-group col-span-4 flex items-center h-full">
                      ${thresholdInput}
                 </div>
                 <div class="input-group col-span-7">
                     <div class="input-wrapper">
                         <input type="number" class="shot-odd-input w-full" step="0.01" value="${odd || ''}">
                         ${calcButton}
                     </div>
                 </div>
                 <div class="col-span-1 flex justify-end">
                    <button type="button" class="remove-shot-line-btn text-slate-400 hover:text-red-500" title="Ukloni liniju">&times;</button>
                 </div>
            </div>`;
        };

        const addPlayer = (playerData = {}) => {
            playerCounter++;
            const cardId = `player-card-${playerCounter}`;
            const playerCard = document.createElement('div');
            playerCard.className = 'player-card';
            playerCard.id = cardId;
            playerCard.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-bold text-slate-700">Igrač ${playerCounter}</h3>
                    <button type="button" class="text-slate-400 hover:text-red-600 transition-colors remove-player-btn" title="Ukloni igrača">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
                
                <div class="grid md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="space-y-4">
                        <h4>1. Pronađi i popuni statistiku</h4>
                        <div class="relative input-group">
                            <label>Ime igrača</label>
                            <input type="text" class="player-name-search w-full" placeholder="Počni da kucaš ime..." value="${playerData.name || ''}">
                            <div class="autocomplete-suggestions hidden"></div>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-x-4 gap-y-4">
                            <div class="input-group"><label>Golovi / 90</label><input type="number" class="player-stat" data-stat="Gls_90" step="0.01" value="${playerData.Gls_90 || 0}"></div>
                            <div class="input-group"><label>Asist. / 90</label><input type="number" class="player-stat" data-stat="Ast_90" step="0.01" value="${playerData.Ast_90 || 0}"></div>
                            <div class="input-group"><label>Šutevi u Okvir / 90</label><input type="number" class="player-stat" data-stat="SoT_90" step="0.01" value="${playerData.SoT_90 || 0}"></div>
                            <div class="input-group"><label>Uk. Šuteva / 90</label><input type="number" class="player-stat" data-stat="Sh_90" step="0.01" value="${playerData.Sh_90 || 0}"></div>
                            <div class="input-group"><label>Pasovi / 90</label><input type="number" class="player-stat" data-stat="Pass_Att_90" step="0.01" value="${playerData.Pass_Att_90 || 0}"></div>
                            <div class="input-group"><label>Faulovi / 90</label><input type="number" class="player-stat" data-stat="Fls_90" step="0.01" value="${playerData.Fls_90 || 0}"></div>
                            <div class="input-group"><label>Izn. Faulovi / 90</label><input type="number" class="player-stat" data-stat="Fld_90" step="0.01" value="${playerData.Fld_90 || 0}"></div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h4>2. Osnovne kvote</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-4">
                            <div class="input-group">
                                <label>Kvota: Daje gol</label>
                                <div class="input-wrapper"><input type="number" class="player-base-odd" data-odd-type="daje-gol" step="0.01" value="${playerData.goalscorerOdd || ''}"><button type="button" class="calc-btn" data-odd-type="daje-gol" data-stat-type="Gls_90" title="Izračunaj">&#9924;</button></div>
                            </div>
                            <div class="input-group">
                                <label>Kvota: Asistencija</label>
                                <div class="input-wrapper"><input type="number" class="player-base-odd" data-odd-type="asistencija" step="0.01"><button type="button" class="calc-btn" data-odd-type="asistencija" data-stat-type="Ast_90" title="Izračunaj">&#9924;</button></div>
                            </div>
                            <div class="input-group">
                                <label>Kvota: Šutevi u okvir 1+</label>
                                <div class="input-wrapper"><input type="number" class="player-base-odd" data-odd-type="sutevi-okvir-1" step="0.01"><button type="button" class="calc-btn" data-odd-type="sutevi-okvir-1" data-stat-type="SoT_90" title="Izračunaj">&#9924;</button></div>
                            </div>
                             <div class="input-group">
                                <label>Kvota: Načinjeni faulovi 1+</label>
                                <div class="input-wrapper"><input type="number" class="player-base-odd" data-odd-type="faulovi-1" step="0.01"><button type="button" class="calc-btn" data-odd-type="faulovi-1" data-stat-type="Fls_90" title="Izračunaj">&#9924;</button></div>
                            </div>
                            <div class="input-group">
                                <label>Kvota: Iznuđeni faulovi 1+</label>
                                <div class="input-wrapper"><input type="number" class="player-base-odd" data-odd-type="faulovi-iznudjeni-1" step="0.01"><button type="button" class="calc-btn" data-odd-type="faulovi-iznudjeni-1" data-stat-type="Fld_90" title="Izračunaj">&#9924;</button></div>
                            </div>
                            <div class="input-group">
                                <label>Kvota: Žuti karton</label>
                                <div class="input-wrapper">
                                    <input type="number" class="player-base-odd" data-odd-type="zuti-karton" step="0.01">
                                    <button type="button" class="calc-btn" data-odd-type="zuti-karton" data-stat-type="Fls_90" title="Izračunaj">&#9924;</button>
                                </div>
                            </div>
                             <div class="input-group sm:col-span-2">
                                <label>Očekivani broj pasova (λ)</label>
                                <div class="input-wrapper"><input type="number" class="player-base-odd" data-odd-type="pasovi-lambda" step="0.01"><button type="button" class="calc-btn" data-odd-type="pasovi-lambda" data-stat-type="Pass_Att_90" title="Izračunaj">&#9924;</button></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="border-t border-slate-200 pt-6 mt-6">
                     <h4>3. Ukupno Šuteva</h4>
                     <div class="shots-lines-container space-y-2 mt-4"></div>
                     <button type="button" class="add-shot-line-btn mt-3 text-sm text-blue-600 font-medium hover:text-blue-800 flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Dodaj Prilagođenu Liniju
                    </button>
                </div>
                `;
             return playerCard;
        };

        const populateStandardShotLines = (card) => {
            const container = card.querySelector('.shots-lines-container');
            const statInput = card.querySelector('.player-stat[data-stat="Sh_90"]');
            const lambda = parseFloat(statInput.value) || 0;
            const margin = parseFloat($('#bookmaker-margin').value) || 0;
            if (!container || lambda <= 0) {
                if(container) container.innerHTML = '<p class="text-sm text-slate-400">Unesite statistiku "Uk. Šuteva / 90" da bi se generisale linije.</p>';
                return;
            };

            container.innerHTML = ''; // Clear existing lines
            for (let k = 1; k <= 5; k++) {
                const prob_less_than_k = poissonCDF(lambda, k - 1);
                const probability = 1 - prob_less_than_k;
                let rawOdd = probToOdd(probability);
                let finalOdd = applyMarginToOdd(rawOdd, margin);
                container.insertAdjacentHTML('beforeend', createShotLineHTML(k, formatOdd(finalOdd), false));
            }
        };
        
        const selectPlayerFromDb = (inputElement, player) => {
            const card = inputElement.closest('.player-card');
            card.querySelector('[data-stat="Gls_90"]').value = player.Gls_90 || 0;
            card.querySelector('[data-stat="Ast_90"]').value = player.Ast_90 || 0;
            card.querySelector('[data-stat="SoT_90"]').value = player.SoT_90 || 0;
            card.querySelector('[data-stat="Sh_90"]').value = player.Sh_90 || 0;
            card.querySelector('[data-stat="Pass_Att_90"]').value = player.Pass_Att_90 || 0;
            card.querySelector('[data-stat="Fls_90"]').value = player.Fls_90 || 0;
            card.querySelector('[data-stat="Fld_90"]').value = player.Fld_90 || 0;
            populateStandardShotLines(card);
        };
        
        const showAutocomplete = (inputElement) => {
            const suggestionsContainer = inputElement.nextElementSibling;
            const value = inputElement.value.toLowerCase();
            const selectedTeam = teamFilter.value;
            let sourceData = allFbrefStats;
            if (selectedTeam) {
                sourceData = allFbrefStats.filter(p => p.Squad === selectedTeam);
            }
            suggestionsContainer.innerHTML = '';
            if (!value) {
                suggestionsContainer.classList.add('hidden');
                return;
            }
            const suggestions = sourceData.filter(p => p.Player.toLowerCase().includes(value)).slice(0, 10);
            if (suggestions.length === 0) {
                suggestionsContainer.classList.add('hidden');
                return;
            }
            suggestions.forEach(player => {
                const div = document.createElement('div');
                div.innerHTML = player.Player.replace(new RegExp(value, 'gi'), match => `<span class="highlight">${match}</span>`);
                div.onclick = () => {
                     inputElement.value = player.Player;
                     suggestionsContainer.classList.add('hidden');
                     selectPlayerFromDb(inputElement, player);
                }
                suggestionsContainer.appendChild(div);
            });
            suggestionsContainer.classList.remove('hidden');
        };
        
        const calculateOddForLine = (button) => {
             const line = button.closest('.shot-line');
             const card = button.closest('.player-card');
             if (!line || !card) return;

             const k = parseInt(line.querySelector('.shots-threshold').value, 10);
             const oddInput = line.querySelector('.shot-odd-input');
             const statInput = card.querySelector('.player-stat[data-stat="Sh_90"]');
             const lambda = parseFloat(statInput.value) || 0;
             const margin = parseFloat($('#bookmaker-margin').value) || 0;

             if (isNaN(k) || k < 1 || lambda <= 0) {
                 oddInput.value = '';
                 return;
             }
             const prob_less_than_k = poissonCDF(lambda, k - 1);
             const probability = 1 - prob_less_than_k;
             let rawOdd = probToOdd(probability);
             let finalOdd = applyMarginToOdd(rawOdd, margin);
             oddInput.value = formatOdd(finalOdd);
        };

        const calculateSingleBaseOdd = (button) => {
            const { oddType, statType } = button.dataset;
            const card = button.closest('.player-card');
            if (!card) return;
            const statInput = card.querySelector(`.player-stat[data-stat="${statType}"]`);
            const oddInput = card.querySelector(`.player-base-odd[data-odd-type="${oddType}"]`);
            const statValue = parseFloat(statInput.value) || 0;
            const margin = parseFloat($('#bookmaker-margin').value) || 0;

            if (statValue <= 0) {
                oddInput.value = '';
                return;
            }

            if (oddType === 'pasovi-lambda') {
                oddInput.value = statValue.toFixed(2);
            } else if (oddType === 'zuti-karton') {
                const prob_1_plus_fouls = 1 - poissonProbability(statValue, 0);
                const odd_1_plus_fouls = probToOdd(prob_1_plus_fouls);
                if (odd_1_plus_fouls) {
                    let rawOdd = odd_1_plus_fouls * 3.2;
                    let finalOdd = applyMarginToOdd(rawOdd, margin);
                    oddInput.value = formatOdd(finalOdd);
                } else {
                    oddInput.value = '';
                }
            } else {
                const probability = 1 - poissonProbability(statValue, 0);
                let rawOdd = probToOdd(probability);
                let finalOdd = applyMarginToOdd(rawOdd, margin);
                oddInput.value = formatOdd(finalOdd);
            }
        };

        // --- Main Calculation Logic ---
        const calculateOdds = () => {
            let allResults = [];
            const playerCards = document.querySelectorAll('.player-card');
            const margin = parseFloat($('#bookmaker-margin').value) || 0;
            const teamWinOdd = parseFloat($('#team-win-odd').value) || 0;
            const correlationFactor = parseFloat($('#correlation-factor').value) || 1.0;

            const createBet = (playerName, m2, m3, o, amf = true) => {
                const finalOddValue = amf ? applyMarginToOdd(o, margin) : o;
                
                if (finalOddValue === null || finalOddValue <= 1) return;

                const isShotsMarket = m2.includes('suteva');
                if (isShotsMarket && finalOddValue > 7) return;
                if (!isShotsMarket && finalOddValue > 150) return;

                allResults.push({ player: playerName, market2: m2, market3: m3, odd: formatOdd(finalOddValue) });
            };

            playerCards.forEach(card => {
                const playerName = card.querySelector('.player-name-search').value || "Igrač";
                if (!playerName) return;
                
                const baseOdds = {};
                card.querySelectorAll('.player-base-odd').forEach(input => baseOdds[input.dataset.oddType] = parseFloat(input.value) || 0);
                
                if (baseOdds['daje-gol'] > 0) {
                    const lambda = getLambdaFromProb(oddToProb(baseOdds['daje-gol']));
                    const p = [poissonProbability(lambda, 0), poissonProbability(lambda, 1), poissonProbability(lambda, 2)];
                    createBet(playerName, 'daje', 'gol', baseOdds['daje-gol'], false);
                    createBet(playerName, 'daje gol', 'do 10. min', probToOdd(1 - poissonProbability(lambda / 9, 0)));
                    createBet(playerName, 'daje', '2+ golova', probToOdd(1 - p[0] - p[1]));
                    createBet(playerName, 'daje', '3+ golova', probToOdd(1 - p[0] - p[1] - p[2]));
                    createBet(playerName, 'daje gol', 'u 1. poluvremenu', probToOdd(1 - poissonProbability(lambda * 0.44, 0)));
                    createBet(playerName, 'daje gol', 'u 2. poluvremenu', probToOdd(1 - poissonProbability(lambda * 0.56, 0)));
                    createBet(playerName, 'daje gol', 'u oba pol.', probToOdd((1 - poissonProbability(lambda * 0.44, 0)) * (1 - poissonProbability(lambda * 0.56, 0))));
                    createBet(playerName, 'daje', 'prvi gol', baseOdds['daje-gol'] * 2.6);
                    createBet(playerName, 'daje', 'zadnji gol', baseOdds['daje-gol'] * 2.6);
                    
                    if (teamWinOdd > 1) {
                        const probPlayerScores = oddToProb(baseOdds['daje-gol']);
                        const probTeamWins = oddToProb(teamWinOdd);
                        const probPlayerScoresInWin = probPlayerScores * correlationFactor;
                        const cappedProbPlayerScoresInWin = Math.min(probPlayerScoresInWin, 0.99);
                        const combinedProb = cappedProbPlayerScoresInWin * probTeamWins;
                        const oddScoresAndWins = probToOdd(combinedProb);
                        createBet(playerName, 'daje gol', 'i tim pobedjuje', oddScoresAndWins, true);
                    }
                }
                if (baseOdds['sutevi-okvir-1'] > 0) {
                    const lambda = getLambdaFromProb(oddToProb(baseOdds['sutevi-okvir-1']));
                    const p = [poissonProbability(lambda, 0), poissonProbability(lambda, 1), poissonProbability(lambda, 2)];
                    createBet(playerName, 'ukupno suteva', 'u okvir gola 1+', baseOdds['sutevi-okvir-1'], false);
                    createBet(playerName, 'ukupno suteva', 'u okvir gola 2+', probToOdd(1 - p[0] - p[1]));
                    createBet(playerName, 'ukupno suteva', 'u okvir gola 3+', probToOdd(1 - p[0] - p[1] - p[2]));
                }
                if (baseOdds['faulovi-1'] > 0) {
                    const lambda = getLambdaFromProb(oddToProb(baseOdds['faulovi-1']));
                    const p = [poissonProbability(lambda, 0), poissonProbability(lambda, 1), poissonProbability(lambda, 2)];
                    createBet(playerName, 'ukupno nacinjenih', 'faulova 1+', baseOdds['faulovi-1'], false);
                    createBet(playerName, 'ukupno nacinjenih', 'faulova 2+', probToOdd(1 - p[0] - p[1]));
                    createBet(playerName, 'ukupno nacinjenih', 'faulova 3+', probToOdd(1 - p[0] - p[1] - p[2]));
                }
                if (baseOdds['zuti-karton'] > 0) {
                    createBet(playerName, 'dobija', 'karton', baseOdds['zuti-karton'], false);
                }
                if (baseOdds['faulovi-iznudjeni-1'] > 0) {
                    const lambda = getLambdaFromProb(oddToProb(baseOdds['faulovi-iznudjeni-1']));
                    const p = [poissonProbability(lambda, 0), poissonProbability(lambda, 1), poissonProbability(lambda, 2)];
                    createBet(playerName, 'ukupno iznudjenih', 'faulova 1+', baseOdds['faulovi-iznudjeni-1'], false);
                    createBet(playerName, 'ukupno iznudjenih', 'faulova 2+', probToOdd(1 - p[0] - p[1]));
                    createBet(playerName, 'ukupno iznudjenih', 'faulova 3+', probToOdd(1 - p[0] - p[1] - p[2]));
                }
                if (baseOdds['pasovi-lambda'] > 0) {
                    const lambda = baseOdds['pasovi-lambda'];
                    const line = Math.ceil(lambda);
                    if (line > 0) createBet(playerName, 'ukupno pasova', `${line}+`, probToOdd(1 - poissonCDF(lambda, line - 1)));
                }
                if (baseOdds['asistencija'] > 0) {
                    createBet(playerName, 'asistencija', '1+', baseOdds['asistencija'], false);
                    if (baseOdds['daje-gol'] > 0) {
                        const prob_goal = oddToProb(baseOdds['daje-gol']);
                        const prob_assist = oddToProb(baseOdds['asistencija']);
                        createBet(playerName, 'daje gol', 'ili asistencija', probToOdd(prob_goal + prob_assist - (prob_goal * prob_assist)));
                    }
                }
                
                card.querySelectorAll('.shot-line').forEach(line => {
                    const oddValue = parseFloat(line.querySelector('.shot-odd-input').value);
                    const thresholdEl = line.querySelector('.shots-threshold');
                    let threshold;
                    if(thresholdEl) {
                        threshold = thresholdEl.value;
                    } else {
                        threshold = line.dataset.threshold;
                    }

                    if (threshold && oddValue > 0) {
                        createBet(playerName, 'ukupno suteva', `${threshold}+`, oddValue, false);
                    }
                });
            });
            return allResults;
        };

        // --- UI Update & CSV ---
        const updatePreviewTable = (data) => {
            previewTableBody.innerHTML = '';
            if (data.length === 0) {
                previewSection.classList.add('hidden');
                return;
            }
            data.sort((a,b) => a.player.localeCompare(b.player) || (a.market2+a.market3).localeCompare(b.market2+b.market3))
                .forEach((item) => {
                    const row = previewTableBody.insertRow();
                    row.className = 'bg-white even:bg-slate-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-800">${item.player}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${item.market2}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${item.market3}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-blue-600">${item.odd}</td>
                        <td class="px-4 py-4 text-center">
                            <button type="button" class="remove-preview-row" title="Ukloni ovu kvotu iz CSV-a">&times;</button>
                        </td>
                    `;
            });
            previewSection.classList.remove('hidden');
        };

        const downloadCSV = () => {
            const visibleRows = previewTableBody.querySelectorAll('tr');
            if (visibleRows.length === 0) {
                alert("Nema podataka za generisanje CSV fajla.");
                return;
            }

            const header = "Datum,Vreme,Sifra,Domacin,Gost,1,X,2,GR,U,O,Yes,No\r\n";
            let csvContent = header;

            const matchName = $('#match-name').value || 'MATCH';
            const matchRow = [`MATCH_NAME:${matchName}`, '', '', '', '', '', '', '', '', '', '', '', ''].join(',');
            csvContent += matchRow + '\r\n';
            
            const dateVal = $('#kickoff-date').value;
            const timeVal = $('#kickoff-time').value;
            let date, time;

            if (dateVal) {
                const [y, m, d] = dateVal.split('-');
                date = `${d}.${m}.${y}`;
            } else {
                const now = new Date();
                date = `${now.getDate()}.${now.getMonth() + 1}.${now.getFullYear()}`;
            }
            time = timeVal || get24hTime(new Date());

            const playerData = {};
            visibleRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const playerName = cells[0].textContent;
                if (!playerData[playerName]) {
                    playerData[playerName] = [];
                }
                playerData[playerName].push({
                    market2: cells[1].textContent,
                    market3: cells[2].textContent,
                    odd: cells[3].textContent,
                });
            });

            for (const playerName in playerData) {
                const leagueRow = [`LEAGUE_NAME:${playerName}`, '', '', '', '', '', '', '', '', '', '', '', ''].join(',');
                csvContent += leagueRow + '\r\n';
                
                playerData[playerName].forEach(item => {
                    const rowData = [ date, time, '', item.market2, item.market3, item.odd, '', '', '', '', '', '', '' ];
                    csvContent += rowData.join(',') + '\r\n';
                });
                csvContent += '\n';
            }
            
            const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${matchName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_odds.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        // --- Form Reset & Initial Load ---
        const resetForm = () => {
            $('#odds-form').reset();
            const now = new Date();
            $('#kickoff-date').value = now.toISOString().split('T')[0];
            $('#kickoff-time').value = get24hTime(now);
            playersContainer.innerHTML = '';
            playerCounter = 0;
            addPlayer(); // Add one empty manual card
            previewSection.classList.add('hidden');
            teamFilter.value = '';
            apiPlayerAdder.classList.add('hidden');
            apiPlayerSelect.innerHTML = '';
        };

        const populateTeamFilter = (teams) => {
            teamFilter.innerHTML = '<option value="">-- Ručni filter --</option>';
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamFilter.appendChild(option);
            });
        };

        const fetchFbrefData = async () => {
            const indicator = $('#status-indicator');
            const statusText = $('#status-text');
            try {
                // IMPORTANT: Make sure this file exists in your project directory
                const response = await fetch('/player_data/merged_player_stats.json'); 
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                allFbrefStats = await response.json();
                indicator.classList.replace('bg-red-500', 'bg-green-500');
                indicator.classList.replace('pulse-red', 'pulse-green');
                statusText.textContent = 'Lokalna baza učitana';
                statusText.className = 'text-green-700';
                indicator.title = `Uspešno učitano ${allFbrefStats.length} igrača.`;
                const teams = [...new Set(allFbrefStats.map(p => p.Squad))].sort();
                populateTeamFilter(teams);
            } catch (error) {
                console.error("Greška pri učitavanju lokalnih podataka:", error);
                indicator.title = "Greška: Nije moguće učitati 'merged_player_stats.json'.";
                statusText.textContent = 'Greška učitavanja baze';
                statusText.className = 'text-red-600';
                alert("Nije moguće učitati lokalnu bazu podataka. Proverite da li fajl 'player_data/merged_player_stats.json' postoji.");
            }
        };
        
        // --- API Functions ---
        const fetchApiEvents = async () => {
            apiBtnText.textContent = 'Učitavam...';
            fetchApiBtn.disabled = true;
            apiStatus.textContent = 'Preuzimanje podataka sa API-ja...';
            
            const url = `/.netlify/functions/fetch-events`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(`API greška: ${errData.error || response.statusText}`);
                }
                const data = await response.json();
                
                const competitionsWithGoalscorerMarket = data.competitions.map(comp => {
                    const relevantEvents = comp.events.filter(event => event.markets && event.markets['soccer.anytime_goalscorer']);
                    return { ...comp, events: relevantEvents };
                }).filter(comp => comp.events.length > 0);

                apiEvents = competitionsWithGoalscorerMarket.flatMap(comp => comp.events.map(event => ({...event, competitionName: comp.name, competitionKey: comp.key })));

                if (apiEvents.length === 0) {
                     apiStatus.textContent = 'Nije pronađen nijedan meč sa kvotama za strelce.';
                } else {
                     populateCompetitionSelect(competitionsWithGoalscorerMarket);
                     apiStatus.textContent = `Uspešno učitano ${apiEvents.length} mečeva sa ponudom za strelce.`;
                     competitionSelect.disabled = false;
                }

            } catch (error) {
                apiStatus.textContent = `Greška: ${error.message}`;
                console.error("API Fetch Error:", error);
            } finally {
                apiBtnText.textContent = 'Učitaj Mečeve sa API-ja';
                fetchApiBtn.disabled = false;
            }
        };

        const populateCompetitionSelect = (competitions) => {
            const competitionKeys = [...new Set(apiEvents.map(e => e.competitionKey))];
            competitionSelect.innerHTML = '<option value="">-- Izaberi Takmičenje --</option>';
            competitionKeys.forEach(key => {
                const comp = competitions.find(c => c.key === key);
                if (comp) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = comp.name;
                    competitionSelect.appendChild(option);
                }
            });
        };
        
        const populateEventSelect = (competitionKey) => {
            eventSelect.innerHTML = '<option value="">-- Izaberi Meč --</option>';
            teamSelect.innerHTML = '';
            teamSelect.disabled = true;
            apiPlayerAdder.classList.add('hidden');
            if (!competitionKey) {
                eventSelect.disabled = true;
                return;
            }
            const eventsInCompetition = apiEvents.filter(e => e.competitionKey === competitionKey);
            eventsInCompetition.forEach(event => {
                const option = document.createElement('option');
                option.value = event.id;
                option.textContent = `${event.home.name} vs ${event.away.name}`;
                eventSelect.appendChild(option);
            });
            eventSelect.disabled = false;
        };
        
        const populateApiPlayerSelect = (players) => {
            apiPlayerSelect.innerHTML = '<option value="">-- Izaberi igrača --</option>';
            if (!players || players.length === 0) {
                apiPlayerAdder.classList.add('hidden');
                return;
            }
            players.sort((a,b) => a.name.localeCompare(b.name)).forEach(player => {
                const option = document.createElement('option');
                option.value = player.name;
                option.textContent = `${player.name} (${player.goalscorerOdd})`;
                option.dataset.odd = player.goalscorerOdd;
                apiPlayerSelect.appendChild(option);
            });
            apiPlayerAdder.classList.remove('hidden');
        };

        const populateMatchData = (eventId) => {
            playersContainer.innerHTML = ''; // Clear existing player cards
            playerCounter = 0;
            const event = apiEvents.find(e => e.id == eventId);
            if (!event) {
                apiPlayerAdder.classList.add('hidden');
                return;
            }

            $('#match-name').value = `${event.home.name} vs ${event.away.name}`;
            const kickoff = new Date(event.cutoffTime);
            $('#kickoff-date').value = kickoff.toISOString().split('T')[0];
            $('#kickoff-time').value = get24hTime(kickoff);

            teamSelect.innerHTML = `<option value="all">Svi Igrači</option>`;
            const matchOddsMarket = event.markets?.['soccer.match_odds']?.submarkets?.['period=ft']?.selections;
            if (matchOddsMarket) {
                const homeOdd = matchOddsMarket.find(s => s.outcome === 'home')?.price;
                const awayOdd = matchOddsMarket.find(s => s.outcome === 'away')?.price;
                teamSelect.innerHTML += `<option value="home" data-odd="${homeOdd || ''}">${event.home.name}</option>`;
                teamSelect.innerHTML += `<option value="away" data-odd="${awayOdd || ''}">${event.away.name}</option>`;
                $('#team-win-odd').value = homeOdd || '';
            }
            teamSelect.disabled = false;
            
            // Extract players and populate the dropdown
            availableApiPlayers = [];
            const goalscorerSelections = event.markets?.['soccer.anytime_goalscorer']?.submarkets?.['period=ft']?.selections;

            if (event.players && Object.keys(event.players).length > 0) {
                 for (const playerKey in event.players) {
                     const player = event.players[playerKey];
                     let selection = goalscorerSelections?.find(s => s.name === player.name || s.outcome === `player=${playerKey}`);
                     if (selection && selection.status === 'SELECTION_ENABLED') {
                        availableApiPlayers.push({
                            name: player.name,
                            goalscorerOdd: selection.price,
                            teamSide: player.team.toLowerCase()
                        });
                     }
                 }
            } else if (goalscorerSelections) { // Fallback
                 goalscorerSelections.forEach(selection => {
                    if (selection.status === 'SELECTION_ENABLED') {
                        const playerName = parsePlayerNameFromOutcome(selection.outcome);
                        // Cannot determine team side in this fallback case
                        availableApiPlayers.push({ name: playerName, goalscorerOdd: selection.price, teamSide: 'all' });
                    }
                 });
            }
            populateApiPlayerSelect(availableApiPlayers);
        };


        // --- Event Listeners ---
        on(fetchApiBtn, 'click', fetchApiEvents);
        on(competitionSelect, 'change', e => populateEventSelect(e.target.value));
        on(eventSelect, 'change', e => populateMatchData(e.target.value));
        on(teamSelect, 'change', e => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const odd = selectedOption.dataset.odd;
            if (odd) {
                $('#team-win-odd').value = odd;
            }
            if (e.target.value === 'all' || !selectedOption.textContent) {
                const eventSelectOption = eventSelect.options[eventSelect.selectedIndex];
                $('#match-name').value = eventSelectOption.textContent || '';
            } else {
                $('#match-name').value = selectedOption.textContent;
            }
            
            // Filter the player dropdown based on selected team
            const selectedTeamSide = e.target.value;
            const playersToDisplay = selectedTeamSide === 'all' 
                ? availableApiPlayers 
                : availableApiPlayers.filter(p => p.teamSide === selectedTeamSide);
            populateApiPlayerSelect(playersToDisplay);
        });

        on(addApiPlayerBtn, 'click', () => {
            const selectedOption = apiPlayerSelect.options[apiPlayerSelect.selectedIndex];
            if (!selectedOption || !selectedOption.value) return;

            const playerName = selectedOption.value;
            const goalscorerOdd = selectedOption.dataset.odd;

            // Check if player is already on the list
            const existingPlayers = Array.from(document.querySelectorAll('.player-name-search')).map(input => input.value);
            if (existingPlayers.includes(playerName)) {
                alert(`Igrač ${playerName} je već dodat.`);
                return;
            }

            const playerCard = addPlayer({ name: playerName, goalscorerOdd });
            playersContainer.appendChild(playerCard);
            
            const fbrefPlayer = allFbrefStats.find(p => p.Player.toLowerCase() === playerName.toLowerCase());
            if (fbrefPlayer) {
                const nameInput = playerCard.querySelector('.player-name-search');
                selectPlayerFromDb(nameInput, fbrefPlayer);
            }
        });

        on(generateBtn, 'click', (e) => { 
            e.preventDefault(); 
            const btnText = $('#generate-btn-text');
            generateBtn.disabled = true;
            btnText.textContent = 'Računam...';
            setTimeout(() => {
                const generatedData = calculateOdds(); 
                updatePreviewTable(generatedData);
                generateBtn.disabled = false;
                btnText.textContent = 'Generiši Kvote';
            }, 50);
        });
        on(downloadCsvBtn, 'click', downloadCSV);
        on(addPlayerBtn, 'click', () => playersContainer.appendChild(addPlayer()));
        on(resetBtn, 'click', resetForm);
        
        on(playersContainer, 'input', e => { 
            if (e.target.classList.contains('player-name-search')) showAutocomplete(e.target);
            if (e.target.matches('.player-stat[data-stat="Sh_90"]')) {
                const card = e.target.closest('.player-card');
                populateStandardShotLines(card);
            }
        });
        on(document, 'click', e => {
             if (!e.target.closest('.player-name-search')) {
                document.querySelectorAll('.autocomplete-suggestions').forEach(s => s.classList.add('hidden'));
            }
        });
        on(playersContainer, 'click', e => {
            const target = e.target.closest('button');
            if (!target) return;

            if (target.classList.contains('remove-player-btn')) {
                target.closest('.player-card')?.remove();
            } else if (target.classList.contains('add-shot-line-btn')) {
                const container = target.previousElementSibling;
                container.insertAdjacentHTML('beforeend', createShotLineHTML('', '', true));
            } else if (target.classList.contains('calc-shot-btn')) {
                calculateOddForLine(target);
            } else if (target.classList.contains('remove-shot-line-btn')) {
                target.closest('.shot-line')?.remove();
            } else if (target.classList.contains('calc-btn')) {
                calculateSingleBaseOdd(target);
            }
        });
        on(previewTableBody, 'click', e => {
            const target = e.target.closest('.remove-preview-row');
            if (target) {
                target.closest('tr').remove();
            }
        });
        
        on(teamFilter, 'change', () => {
            const selectedTeam = teamFilter.value;
            if (selectedTeam) $('#match-name').value = selectedTeam;
        });
        
        // --- Initial Setup ---
        window.onload = () => {
            const now = new Date();
            $('#kickoff-date').value = now.toISOString().split('T')[0];
            $('#kickoff-time').value = get24hTime(now);
            teamFilter.value = '';
            apiPlayerAdder.classList.add('hidden');
            apiPlayerSelect.innerHTML = '';
            fetchFbrefData();
        };
    </script>
</body>
</html>
