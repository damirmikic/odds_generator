<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odds Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* --- Base Input Styling --- */
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #475569;
            font-weight: 500;
            font-size: 0.875rem;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #f9fafb;
            color: #1f2937;
        }
        .input-group input:disabled, .input-group select:disabled {
             background-color: #e5e7eb;
             cursor: not-allowed;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        /* --- Player Card --- */
        .player-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #ffffff;
            position: relative;
            transition: box-shadow 0.2s;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        .player-card h4 {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #f3f4f6;
            margin-bottom: 1rem;
        }

        /* --- Autocomplete & Utils --- */
        .input-wrapper { position: relative; }
        .calc-btn {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background-color: #e5e7eb;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4b5563;
            transition: all 0.2s ease;
        }
        .calc-btn:hover { background-color: #d1d5db; color: #1f2937; }
        .remove-preview-row {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fecaca;
            border-radius: 9999px;
            width: 1.5rem;
            height: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .remove-preview-row:hover {
            background-color: #ef4444;
            color: white;
            border-color: #ef4444;
        }
        .autocomplete-suggestions {
            position: absolute;
            border: 1px solid #e5e7eb;
            background-color: white;
            z-index: 99;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .autocomplete-suggestions div { padding: 0.75rem; cursor: pointer; }
        .autocomplete-suggestions div:hover { background-color: #f3f4f6; }
        .autocomplete-suggestions .highlight { font-weight: bold; color: #1e293b; }

        /* --- Status Indicator --- */
        @keyframes pulse-green { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .pulse-green { animation: pulse-green 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulse-red { animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        /* --- Action Buttons --- */
        .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 700;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            transition: all 0.2s ease-in-out;
            transform: translateY(0);
        }
        .action-btn:hover {
             box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
             transform: translateY(-2px);
        }
        .action-btn:focus {
            outline: none;
        }
        .action-btn.primary {
            background-image: linear-gradient(to right, #3b82f6, #2563eb);
            color: white;
        }
        .action-btn.primary:focus-visible {
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
        }
         .action-btn.primary:disabled {
            background-image: none;
            background-color: #93c5fd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .action-btn.secondary {
            background-color: #4b5563;
            color: white;
        }
         .action-btn.secondary:hover {
            background-color: #374151;
        }
        .action-btn.secondary:focus-visible {
            box-shadow: 0 0 0 4px rgba(75, 85, 99, 0.4);
        }
        .action-btn.success {
            background-image: linear-gradient(to right, #22c55e, #16a34a);
            color: white;
        }
         .action-btn.success:hover {
            opacity: 0.9;
        }
         .action-btn.success:focus-visible {
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.4);
        }
        .action-btn.add-player {
            background-image: linear-gradient(to right, #10b981, #059669);
            color: white;
        }
        .action-btn.add-player:hover {
            opacity: 0.9;
        }
        .action-btn.add-player:focus-visible {
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.4);
        }
    </style>
</head>
<body class="bg-gray-100 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="max-w-6xl mx-auto bg-white rounded-xl border border-slate-200 shadow-sm p-6 sm:p-8">
            <header class="flex items-center justify-between mb-8 border-b border-slate-200 pb-6">
                 <div class="flex items-center gap-4">
                    <div class="bg-blue-100 text-blue-600 p-3 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calculator"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x1="16" y1="14" y2="18"/><line x1="16" x1="12" y1="14" y2="14"/><line x1="12" x1="12" y1="14" y2="18"/><line x1="8" x1="8" y1="10" y2="18"/><line x1="8" x1="12" y1="10" y2="10"/></svg>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-slate-800">Generator Kvota</h1>
                 </div>
                 <div id="status-container" class="flex items-center gap-2.5 text-sm font-medium">
                    <div id="status-indicator" class="w-2.5 h-2.5 rounded-full bg-red-500 pulse-red" title="Status učitavanja baze podataka"></div>
                    <span id="status-text" class="text-slate-500">Učitavanje...</span>
                 </div>
            </header>

            <form id="odds-form">
                <section id="api-section" class="mb-8 p-6 bg-slate-50 border border-slate-200 rounded-lg">
                    <h3 class="font-bold text-lg text-slate-800 mb-4">Preuzimanje Podataka sa API-ja</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-4">
                            <button type="button" id="fetch-api-btn" class="w-full md:w-auto action-btn secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                <span id="api-btn-text">Učitaj Mečeve sa API-ja</span>
                            </button>
                            <p id="api-status" class="text-sm text-slate-500 mt-2 h-5"></p>
                        </div>
                        <div class="input-group">
                            <label for="competition-select">Takmičenje</label>
                            <select id="competition-select" disabled></select>
                        </div>
                        <div class="input-group md:col-span-2">
                            <label for="event-select">Meč</label>
                            <select id="event-select" disabled></select>
                        </div>
                        <div class="input-group">
                            <label for="team-select">Tim</label>
                            <select id="team-select" disabled></select>
                        </div>
                        <div class="input-group md:col-span-2">
                            <label for="player-select">Igrač iz API-ja</label>
                            <select id="player-select" disabled></select>
                        </div>
                        <div class="md:col-span-1 flex items-end">
                           <button type="button" id="add-api-player-btn" class="w-full action-btn add-player" disabled>
                               <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-plus"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8"/><line x1="22" x2="16" y1="11"/></svg>
                               <span>Dodaj Igrača</span>
                           </button>
                       </div>
                    </div>
                </section>

                <section class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-8">
                    <div class="input-group lg:col-span-2"><label for="match-name">Naziv Utakmice</label><input type="text" id="match-name"></div>
                    <div class="input-group"><label for="kickoff-date">Datum početka</label><input type="date" id="kickoff-date"></div>
                    <div class="input-group"><label for="kickoff-time">Vreme početka</label><input type="time" id="kickoff-time"></div>
                    <div class="input-group"><label for="team-win-odd">Kvota na Pobedu</label><input type="number" id="team-win-odd" step="0.01" value="1.85"></div>
                    <div class="input-group"><label for="correlation-factor" class="text-xs sm:text-sm">Faktor Kor. (Gol/Pobeda)</label><input type="number" id="correlation-factor" step="0.1" value="1.3"></div>
                    <div class="input-group"><label for="bookmaker-margin">Margina (%)</label><input type="number" id="bookmaker-margin" step="0.1" value="10"></div>
                </section>
                <section class="border-t border-slate-200 pt-8">
                    <div id="players-section-header" class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-slate-700">Igrači</h3>
                        <div class="input-group max-w-xs">
                            <label for="team-filter" class="sr-only">Filtriraj po Ekipi (iz lokalne baze)</label>
                            <select id="team-filter"></select>
                        </div>
                    </div>
                    <div id="players-container" class="space-y-6"></div>
                </section>
                <div class="flex justify-center mt-6 mb-8"><button type="button" id="add-player-btn" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all transform hover:scale-105"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Dodaj Igrača Ručno</button></div>
            </form>

            <div class="flex flex-col md:flex-row justify-center items-center gap-4 my-8">
                <button id="generate-btn" class="w-full md:w-auto action-btn primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-zap"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                    <span id="generate-btn-text">Generiši Kvote</span>
                </button>
                <button type="button" id="reset-btn" class="w-full md:w-auto action-btn secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw"><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 1 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path></svg>
                    Poništi Unos
                </button>
            </div>

            <div id="preview-section" class="hidden">
                <h2 class="text-xl sm:text-2xl font-bold text-slate-800 mb-6 text-center">Pregled Generisanih Kvota</h2>
                <div class="overflow-x-auto rounded-lg border border-slate-200">
                    <table class="min-w-full">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Igrač</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Opis 1</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Opis 2</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Kvota</th>
                                <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Ukloni</th>
                            </tr>
                        </thead>
                        <tbody id="preview-table-body" class="bg-white"></tbody>
                    </table>
                </div>
                <div class="flex justify-center mt-8">
                    <button id="download-csv-btn" class="w-full md:w-auto action-btn success">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download-cloud"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"></path><path d="M12 12v9"></path><path d="m8 17 4 4 4-4"></path></svg>
                        Preuzmi CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const $ = (selector) => document.querySelector(selector);
        const on = (element, event, handler) => element.addEventListener(event, handler);
        
        // DOM Element Constants
        const generateBtn = $('#generate-btn');
        const downloadCsvBtn = $('#download-csv-btn');
        const addPlayerBtn = $('#add-player-btn');
        const resetBtn = $('#reset-btn');
        const playersContainer = $('#players-container');
        const previewSection = $('#preview-section');
        const previewTableBody = $('#preview-table-body');
        const teamFilter = $('#team-filter');
        const fetchApiBtn = $('#fetch-api-btn');
        const apiBtnText = $('#api-btn-text');
        const apiStatus = $('#api-status');
        const competitionSelect = $('#competition-select');
        const eventSelect = $('#event-select');
        const teamSelect = $('#team-select');
        const playerSelect = $('#player-select');
        const addApiPlayerBtn = $('#add-api-player-btn');
        
        // Global State
        let playerCounter = 0;
        let allFbrefStats = [];
        let apiEvents = [];

        // --- Math & Stat Helpers ---
        const factorial = n => { if (n < 0) return NaN; if (n === 0) return 1; let r = 1; for (let i = 2; i <= n; i++) r *= i; return r; };
        const poissonProbability = (l, k) => (l < 0) ? 0 : (Math.pow(l, k) * Math.exp(-l)) / factorial(k);
        const probToOdd = p => (p <= 0 || p >= 1) ? null : 1 / p;
        const oddToProb = o => (o <= 1) ? 1 : 1 / o;
        const getLambdaFromProb = p => (p <= 0 || p >= 1) ? 0 : -Math.log(1 - p);
        
        const get24hTime = (date = new Date()) => {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        };
        
        const formatOdd = (o) => {
            if (o === null) return 'N/A';
            if (o <= 1) return '1.01';

            let roundedOdd;
            if (o >= 10) {
                roundedOdd = Math.round(o * 4) / 4;
            } else {
                roundedOdd = Math.round(o * 10) / 10;
            }
            return roundedOdd.toFixed(2);
        };

        const poissonCDF = (lambda, k) => {
            let sum = 0;
            for (let i = 0; i <= k; i++) {
                sum += poissonProbability(lambda, i);
            }
            return sum;
        };
        const applyMarginToOdd = (odd, margin) => {
            if (!odd || margin <= 0 || odd <= 1) return odd;
            const p = 1 / odd;
            const ap = p * (1 + (margin / 100));
            return probToOdd(ap);
        }
        
        const parsePlayerNameFromOutcome = (outcome) => {
            if (!outcome || !outcome.startsWith('player=')) return 'Unknown Player';
            let namePart = outcome.split('=')[1];
            const firstHyphenIndex = namePart.indexOf('-');
            if (firstHyphenIndex === -1) return 'Unknown Player';
            namePart = namePart.substring(firstHyphenIndex + 1);
            return namePart.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        };


        const populatePlayerSelect = (players) => {
           playerSelect.innerHTML = '<option value="">Izaberi igrača</option>';
           players.forEach(player => {
               const option = document.createElement('option');
               option.value = player.name;
               option.textContent = player.name;
               playerSelect.appendChild(option);
           });
           playerSelect.disabled = false;
           addApiPlayerBtn.disabled = true;
       };

        // --- Player Card Management ---
        const createShotLineHTML = (threshold, odd, isCustom = false) => {
            const thresholdInput = isCustom 
                ? `<input type="number" class="shots-threshold w-full" value="${threshold || 1}" min="1" step="1">`
                : `<span class="font-medium text-slate-700">${threshold}+</span>`;
            
            const calcButton = isCustom 
                ? `<button type="button" class="calc-btn calc-shot-btn" title="Izračunaj kvotu za ovu granicu">&#9924;</button>`
                : '';

            return `
            <div class="grid grid-cols-12 gap-x-3 items-center shot-line" data-threshold="${threshold}">
                 <div class="input-group col-span-4 flex items-center h-full">
                      ${thresholdInput}
                 </div>
                 <div class="input-group col-span-7">
                     <div class="input-wrapper">
                         <input type="number" class="shot-odd-input w-full" step="0.01" value="${odd || ''}">
                         ${calcButton}
                     </div>
                 </div>
                 <div class="col-span-1 flex justify-end">
                    <button type="button" class="remove-shot-line-btn text-slate-400 hover:text-red-500" title="Ukloni liniju">&times;</button>
                 </div>
            </div>`;
        };

        const addPlayer = (playerData = {}) => {
            playerCounter++;
            const cardId = `player-card-${playerCounter}`;
            const playerCard = document.createElement('div');
            playerCard.className = 'player-card';
            playerCard.id = cardId;
            playerCard.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-bold text-slate-700">Igrač ${playerCounter}</h3>
                    <button type="button" class="text-slate-400 hover:text-red-600 transition-colors remove-player-btn" title="Ukloni igrača">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
                
                <div class="grid md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="space-y-4">
                        <h4>1. Pronađi i popuni statistiku</h4>
                        <div class="relative input-group">
                            <label>Ime igrača</label>
                            <input type="text" class="player-name-search w-full" placeholder="Počni da kucaš ime..." value="${playerData.name || ''}">
                            <div class="autocomplete-suggestions hidden"></div>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-x-4 gap-y-4">
                            <div class="input-group"><label>Golovi / 90</label><input type="number" class="player-stat" data-stat="Gls_90" step="0.01" value="${playerData.Gls_90 || 0}"></div>
                            <div class="input-group"><label>Asist. / 90</label><input type="number" class="player-stat" data-stat="Ast_90" step="0.01" value="${playerData.Ast_90 || 0}"></div>
                            <div class="input-group"><label>Šutevi u Okvir / 90</label><input type="number" class="player-stat" data-stat="SoT_90" step="0.01" value="${playerData.SoT_90 || 0}"></div>
                            <div class="input-group"><label>Uk. Šuteva / 90</label><input type="number" class="player-stat" data-stat="Sh_90" step="0.01" value="${playerData.Sh_90 || 0}"></div>
                            <div class="input-group"><label>Pasovi / 90</label><input type="number" class="player-stat" data-stat="Pass_Att_90" step="0.01" value="${playerData.Pass_Att_90 || 0}"></div>
                            <div class="input-group"><label>Faulovi / 90</label><input type="number" class="player-stat" data-stat="Fls_90" step="0.01" value="${playerData.Fls_90 || 0}"></div>
                            <div class="input-group"><label>Izn. Faulovi / 90</label><input type="number" class="player-stat" data-stat="Fld_90" step="0.01" value="${playerData.Fld_90 || 0}"></div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h4>2. Osnovne kvote</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-4">
                            <div class="input-group">
                                <label>Kvota: Daje gol</label>
                                <div class="input-wrapper"><input type="number" class="player-base-odd" data-odd-type="daje-gol" step="0.01" value="${playerData.goalscorerOdd || ''}"><button type="button" class="calc-btn" data-odd-type="daje-gol" data-stat-type="Gls_90" title="Izračunaj">&#9924;</button></div>
                            </div>
                            <div class="input-group">
                                <label>Kvota: Asistencija</label>
                                <div class="input-wrapper"><input type="number" class="player-base-odd" data-odd-type="asistencija" step="0.01"><button type="button" class="calc-btn" data-odd-type="asistencija" data-stat-type="Ast_90" title="Izračunaj">&#9924;</button></div>
                            </div>
                            <div class="input-group">
                                <label>Kvota: Šutevi u okvir 1+</label>
                                <div class="input-wrapper"><input type="number" class="player-base-odd" data-odd-type="sutevi-okvir-1" step="0.01"><button type="button" class="calc-btn" data-odd-type="sutevi-okvir-1" data-stat-type="SoT_90" title="Izračunaj">&#9924;</button></div>
                            </div>
                             <div class="input-group">
                                <label>Kvota: Načinjeni faulovi 1+</label>
                                <div class="input-wrapper"><input type="number" class="player-base-odd" data-odd-type="faulovi-1" step="0.01"><button type="button" class="calc-btn" data-odd-type="faulovi-1" data-stat-type="Fls_90" title="Izračunaj">&#9924;</button></div>
                            </div>
                            <div class="input-group">
                                <label>Kvota: Iznuđeni faulovi 1+</label>
                                <div class="input-wrapper"><input type="number" class="player-base-odd" data-odd-type="faulovi-iznudjeni-1" step="0.01"><button type="button" class="calc-btn" data-odd-type="faulovi-iznudjeni-1" data-stat-type="Fld_90" title="Izračunaj">&#9924;</button></div>
                            </div>
                             <div class="input-group sm:col-span-2">
                                <label>Očekivani broj pasova (λ)</label>
                                <div class="input-wrapper"><input type="number" class="player-base-odd" data-odd-type="pasovi-lambda" step="0.01"><button type="button" class="calc-btn" data-odd-type="pasovi-lambda" data-stat-type="Pass_Att_90" title="Izračunaj">&#9924;</button></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="border-t border-slate-200 pt-6 mt-6">
                     <h4>3. Ukupno Šuteva</h4>
                     <div class="shots-lines-container space-y-2 mt-4"></div>
                     <button type="button" class="add-shot-line-btn mt-3 text-sm text-blue-600 font-medium hover:text-blue-800 flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Dodaj Prilagođenu Liniju
                    </button>
                </div>
                `;
             playersContainer.appendChild(playerCard);
             return playerCard;
        };

        const populateStandardShotLines = (card) => {
            const container = card.querySelector('.shots-lines-container');
            const statInput = card.querySelector('.player-stat[data-stat="Sh_90"]');
            const lambda = parseFloat(statInput.value) || 0;
            const margin = parseFloat($('#bookmaker-margin').value) || 0;
            if (!container || lambda <= 0) {
                if(container) container.innerHTML = '<p class="text-sm text-slate-400">Unesite statistiku "Uk. Šuteva / 90" da bi se generisale linije.</p>';
                return;
            };

            container.innerHTML = ''; // Clear existing lines
            for (let k = 1; k <= 5; k++) {
                const prob_less_than_k = poissonCDF(lambda, k - 1);
                const probability = 1 - prob_less_than_k;
                let rawOdd = probToOdd(probability);
                let finalOdd = applyMarginToOdd(rawOdd, margin);
                container.insertAdjacentHTML('beforeend', createShotLineHTML(k, formatOdd(finalOdd), false));
            }
        };
        
        const selectPlayerFromDb = (inputElement, player) => {
            const card = inputElement.closest('.player-card');
            card.querySelector('[data-stat="Gls_90"]').value = player.Gls_90 || 0;
            card.querySelector('[data-stat="Ast_90"]').value = player.Ast_90 || 0;
            card.querySelector('[data-stat="SoT_90"]').value = player.SoT_90 || 0;
            card.querySelector('[data-stat="Sh_90"]').value = player.Sh_90 || 0;
            card.querySelector('[data-stat="Pass_Att_90"]').value = player.Pass_Att_90 || 0;
            card.querySelector('[data-stat="Fls_90"]').value = player.Fls_90 || 0;
            card.querySelector('[data-stat="Fld_90"]').value = player.Fld_90 || 0;
            populateStandardShotLines(card);
        };
        
        const showAutocomplete = (inputElement) => {
            const suggestionsContainer = inputElement.nextElementSibling;
            const value = inputElement.value.toLowerCase();
            const selectedTeam = teamFilter.value;
            let sourceData = allFbrefStats;
            if (selectedTeam) {
                sourceData = allFbrefStats.filter(p => p.Squad === selectedTeam);
            }
            suggestionsContainer.innerHTML = '';
            if (!value) {
                suggestionsContainer.classList.add('hidden');
                return;
            }
            const filteredPlayers = sourceData.filter(p => p.Player.toLowerCase().includes(value)).slice(0, 5);
            if (filteredPlayers.length > 0) {
                suggestionsContainer.classList.remove('hidden');
                filteredPlayers.forEach(player => {
                    const div = document.createElement('div');
                    div.innerHTML = player.Player.replace(new RegExp(value, 'gi'), (match) => `<span class="highlight">${match}</span>`);
                    on(div, 'click', () => {
                        inputElement.value = player.Player;
                        suggestionsContainer.classList.add('hidden');
                        selectPlayerFromDb(inputElement, player);
                    });
                    suggestionsContainer.appendChild(div);
                });
            } else {
                suggestionsContainer.classList.add('hidden');
            }
        };

        const calculateAllOdds = () => {
            const playerCards = document.querySelectorAll('.player-card');
            const teamWinOdd = parseFloat($('#team-win-odd').value) || 0;
            const correlationFactor = parseFloat($('#correlation-factor').value) || 1.3;
            const margin = parseFloat($('#bookmaker-margin').value) || 0;
            let allResults = [];

            const createBet = (playerName, m2, m3, odd, isCombo) => {
                if (!odd || odd <= 1) return;
                let finalOddValue = isCombo ? odd : applyMarginToOdd(odd, margin);
                if (!finalOddValue) return;

                const isShotsMarket = m2.includes('suteva');
                if (isShotsMarket && finalOddValue > 7) return;
                if (!isShotsMarket && finalOddValue > 150) return;

                allResults.push({ player: playerName, market2: m2, market3: m3, odd: formatOdd(finalOddValue) });
            };

            playerCards.forEach(card => {
                const playerName = card.querySelector('.player-name-search').value || "Igrač";
                if (!playerName) return;
                
                const baseOdds = {};
                card.querySelectorAll('.player-base-odd').forEach(input => baseOdds[input.dataset.oddType] = parseFloat(input.value) || 0);
                
                if (baseOdds['daje-gol'] > 0) {
                    const lambda = getLambdaFromProb(oddToProb(baseOdds['daje-gol']));
                    const p = [poissonProbability(lambda, 0), poissonProbability(lambda, 1), poissonProbability(lambda, 2)];
                    createBet(playerName, 'daje', 'gol', baseOdds['daje-gol'], false);
                    createBet(playerName, 'daje gol', 'do 10. min', probToOdd(1 - poissonProbability(lambda / 9, 0)));
                    createBet(playerName, 'daje', '2+ golova', probToOdd(1 - p[0] - p[1]));
                    createBet(playerName, 'daje', '3+ golova', probToOdd(1 - p[0] - p[1] - p[2]));
                    createBet(playerName, 'daje gol', 'u 1. poluvremenu', probToOdd(1 - poissonProbability(lambda * 0.44, 0)));
                    createBet(playerName, 'daje gol', 'u 2. poluvremenu', probToOdd(1 - poissonProbability(lambda * 0.56, 0)));
                    createBet(playerName, 'daje gol', 'u oba pol.', probToOdd((1 - poissonProbability(lambda * 0.44, 0)) * (1 - poissonProbability(lambda * 0.56, 0))));
                    createBet(playerName, 'daje', 'prvi gol', baseOdds['daje-gol'] * 2.6);
                    createBet(playerName, 'daje', 'zadnji gol', baseOdds['daje-gol'] * 2.6);
                    
                    if (teamWinOdd > 1) {
                        const probPlayerScores = oddToProb(baseOdds['daje-gol']);
                        const probTeamWins = oddToProb(teamWinOdd);
                        const probPlayerScoresInWin = probPlayerScores * correlationFactor;
                        const cappedProbPlayerScoresInWin = Math.min(probPlayerScoresInWin, 0.99);
                        const combinedProb = cappedProbPlayerScoresInWin * probTeamWins;
                        const oddScoresAndWins = probToOdd(combinedProb);
                        createBet(playerName, 'daje gol', 'i tim pobedjuje', oddScoresAndWins, true);
                    }
                }
                if (baseOdds['sutevi-okvir-1'] > 0) {
                    const lambda = getLambdaFromProb(oddToProb(baseOdds['sutevi-okvir-1']));
                    const p = [poissonProbability(lambda, 0), poissonProbability(lambda, 1), poissonProbability(lambda, 2)];
                    createBet(playerName, 'ukupno suteva', 'u okvir gola 1+', baseOdds['sutevi-okvir-1'], false);
                    createBet(playerName, 'ukupno suteva', 'u okvir gola 2+', probToOdd(1 - p[0] - p[1]));
                    createBet(playerName, 'ukupno suteva', 'u okvir gola 3+', probToOdd(1 - p[0] - p[1] - p[2]));
                }
                if (baseOdds['faulovi-1'] > 0) {
                    const lambda = getLambdaFromProb(oddToProb(baseOdds['faulovi-1']));
                    const p = [poissonProbability(lambda, 0), poissonProbability(lambda, 1), poissonProbability(lambda, 2)];
                    createBet(playerName, 'ukupno nacinjenih', 'faulova 1+', baseOdds['faulovi-1'], false);
                    createBet(playerName, 'ukupno nacinjenih', 'faulova 2+', probToOdd(1 - p[0] - p[1]));
                    createBet(playerName, 'ukupno nacinjenih', 'faulova 3+', probToOdd(1 - p[0] - p[1] - p[2]));
                    createBet(playerName, 'dobija', 'karton', baseOdds['faulovi-1'] * 3.2);
                }
                if (baseOdds['faulovi-iznudjeni-1'] > 0) {
                    const lambda = getLambdaFromProb(oddToProb(baseOdds['faulovi-iznudjeni-1']));
                    const p = [poissonProbability(lambda, 0), poissonProbability(lambda, 1), poissonProbability(lambda, 2)];
                    createBet(playerName, 'ukupno iznudjenih', 'faulova 1+', baseOdds['faulovi-iznudjeni-1'], false);
                    createBet(playerName, 'ukupno iznudjenih', 'faulova 2+', probToOdd(1 - p[0] - p[1]));
                    createBet(playerName, 'ukupno iznudjenih', 'faulova 3+', probToOdd(1 - p[0] - p[1] - p[2]));
                }
                if (baseOdds['pasovi-lambda'] > 0) {
                    const lambda = baseOdds['pasovi-lambda'];
                    const line = Math.ceil(lambda);
                    if (line > 0) createBet(playerName, 'ukupno pasova', `${line}+`, probToOdd(1 - poissonCDF(lambda, line - 1)));
                }
                if (baseOdds['asistencija'] > 0) {
                    createBet(playerName, 'asistencija', '1+', baseOdds['asistencija'], false);
                    if (baseOdds['daje-gol'] > 0) {
                        const prob_goal = oddToProb(baseOdds['daje-gol']);
                        const prob_assist = oddToProb(baseOdds['asistencija']);
                        createBet(playerName, 'daje gol', 'ili asistencija', probToOdd(prob_goal + prob_assist - (prob_goal * prob_assist)));
                    }
                }
                
                card.querySelectorAll('.shot-line').forEach(line => {
                    const oddValue = parseFloat(line.querySelector('.shot-odd-input').value);
                    const thresholdEl = line.querySelector('.shots-threshold');
                    let threshold;
                    if(thresholdEl) {
                        threshold = thresholdEl.value;
                    } else {
                        threshold = line.dataset.threshold;
                    }

                    if (threshold && oddValue > 0) {
                        createBet(playerName, 'ukupno suteva', `${threshold}+`, oddValue, false);
                    }
                });
            });
            return allResults;
        };

        // --- UI Update & CSV ---
        const updatePreviewTable = (data) => {
            previewTableBody.innerHTML = '';
            if (data.length === 0) {
                previewSection.classList.add('hidden');
                return;
            }
            data.sort((a,b) => a.player.localeCompare(b.player) || (a.market2+a.market3).localeCompare(b.market2+b.market3))
                .forEach((item) => {
                    const row = previewTableBody.insertRow();
                    row.className = 'bg-white even:bg-slate-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-800">${item.player}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${item.market2}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${item.market3}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-blue-600">${item.odd}</td>
                        <td class="px-4 py-4 text-center">
                            <button type="button" class="remove-preview-row" title="Ukloni ovu kvotu iz CSV-a">&times;</button>
                        </td>
                    `;
            });
            previewSection.classList.remove('hidden');
        };

        const downloadCSV = () => {
            const visibleRows = previewTableBody.querySelectorAll('tr');
            if (visibleRows.length === 0) {
                alert("Nema podataka za generisanje CSV fajla.");
                return;
            }

            const header = "Datum,Vreme,Sifra,Domacin,Gost,1,X,2,GR,U,O,Yes,No\r\n";
            let csvContent = header;

            const matchName = $('#match-name').value || 'MATCH';
            const matchRow = [`MATCH_NAME:${matchName}`, '', '', '', '', '', '', '', '', '', '', '', ''].join(',');
            csvContent += matchRow + '\r\n';
            
            const dateVal = $('#kickoff-date').value;
            const timeVal = $('#kickoff-time').value;
            let date, time;
            if (dateVal) {
                const d = new Date(dateVal);
                date = `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}.${d.getFullYear()}`;
            } else {
                const today = new Date();
                date = `${String(today.getDate()).padStart(2, '0')}.${String(today.getMonth() + 1).padStart(2, '0')}.${today.getFullYear()}`;
            }
            time = timeVal || get24hTime();

            let currentSifra = 1001;
            const getNextSifra = () => currentSifra++;

            visibleRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const player = cells[0].textContent;
                const market2 = cells[1].textContent;
                const market3 = cells[2].textContent;
                const odd = cells[3].textContent;
                const sifra = getNextSifra();
                const domacin = `${player} ${market2}`;
                const gost = market3;
                const csvRow = [date, time, sifra, domacin, gost, odd, '', '', '', '', '', '', ''].join(',');
                csvContent += csvRow + '\r\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `${matchName.replace(/ /g,"_")}_odds.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        // --- Event Listeners ---
        on(generateBtn, 'click', () => {
            const data = calculateAllOdds();
            updatePreviewTable(data);
        });
        on(downloadCsvBtn, 'click', downloadCSV);
        on(addPlayerBtn, 'click', () => addPlayer());
        on(resetBtn, 'click', () => {
            $('#odds-form').reset();
            playersContainer.innerHTML = '';
            playerCounter = 0;
            addPlayer();
            previewSection.classList.add('hidden');
            previewTableBody.innerHTML = '';
        });
        on(document, 'click', (e) => {
            if (e.target.classList.contains('remove-player-btn')) {
                e.target.closest('.player-card').remove();
            }
            if (e.target.classList.contains('remove-preview-row')) {
                e.target.closest('tr').remove();
            }
            if (e.target.classList.contains('add-shot-line-btn')) {
                const card = e.target.closest('.player-card');
                const container = card.querySelector('.shots-lines-container');
                container.insertAdjacentHTML('beforeend', createShotLineHTML('', '', true));
            }
            if (e.target.classList.contains('remove-shot-line-btn')) {
                e.target.closest('.shot-line').remove();
            }
            if (e.target.classList.contains('calc-btn')) {
                const card = e.target.closest('.player-card');
                const oddType = e.target.dataset.oddType;
                const statType = e.target.dataset.statType;
                const statValue = parseFloat(card.querySelector(`[data-stat="${statType}"]`).value) || 0;
                const margin = parseFloat($('#bookmaker-margin').value) || 0;
                const outputInput = e.target.previousElementSibling;

                if (statValue > 0) {
                    if (oddType.includes('lambda')) {
                        outputInput.value = statValue.toFixed(2);
                    } else {
                        const prob = 1 - poissonProbability(statValue, 0);
                        const rawOdd = probToOdd(prob);
                        outputInput.value = formatOdd(applyMarginToOdd(rawOdd, margin));
                    }
                }
            }
             if (e.target.classList.contains('calc-shot-btn')) {
                const card = e.target.closest('.player-card');
                const line = e.target.closest('.shot-line');
                const threshold = parseInt(line.querySelector('.shots-threshold').value);
                const statValue = parseFloat(card.querySelector('[data-stat="Sh_90"]').value) || 0;
                const margin = parseFloat($('#bookmaker-margin').value) || 0;
                const outputInput = e.target.previousElementSibling;

                if (statValue > 0 && threshold > 0) {
                    const prob = 1 - poissonCDF(statValue, threshold - 1);
                    const rawOdd = probToOdd(prob);
                    outputInput.value = formatOdd(applyMarginToOdd(rawOdd, margin));
                }
            }
        });
        on(document, 'input', (e) => {
            if (e.target.classList.contains('player-name-search')) {
                showAutocomplete(e.target);
            }
            if (e.target.classList.contains('player-stat') && e.target.dataset.stat === 'Sh_90') {
                populateStandardShotLines(e.target.closest('.player-card'));
            }
        });
        on(document, 'focusout', (e) => {
            if (e.target.classList.contains('player-name-search')) {
                setTimeout(() => {
                    if (!e.target.matches(':focus')) {
                         e.target.nextElementSibling.classList.add('hidden');
                    }
                }, 200);
            }
        });

        // --- Initial Load ---
        const loadFbrefDb = async () => {
            try {
                const res = await fetch('/player_data/merged_player_stats.json');
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                allFbrefStats = await res.json();
                
                const teams = [...new Set(allFbrefStats.map(p => p.Squad))].sort();
                teamFilter.innerHTML = '<option value="">Svi Timovi (Lokalna Baza)</option>';
                teams.forEach(team => teamFilter.innerHTML += `<option value="${team}">${team}</option>`);
                
                $('#status-indicator').classList.remove('bg-red-500', 'pulse-red');
                $('#status-indicator').classList.add('bg-green-500', 'pulse-green');
                $('#status-text').textContent = 'Baza je spremna';
            } catch (error) {
                console.error("Failed to load FBREF DB:", error);
                $('#status-text').textContent = 'Greška u bazi';
                $('#status-text').classList.add('text-red-600');
            }
        };
        
        on(fetchApiBtn, 'click', async () => {
            apiBtnText.textContent = 'Učitavanje...';
            fetchApiBtn.disabled = true;
            apiStatus.textContent = '';

            try {
                const response = await fetch('/.netlify/functions/fetch-events');
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Nepoznata greška sa API-ja');
                }
                const data = await response.json();
                apiEvents = data.events; // Correctly access the events array
                
                const competitions = [...new Set(apiEvents.map(e => e.competition.name))];
                competitionSelect.innerHTML = '<option value="">Izaberi takmičenje</option>';
                competitions.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c;
                    option.textContent = c;
                    competitionSelect.appendChild(option);
                });
                competitionSelect.disabled = false;
                apiStatus.textContent = `Uspešno preuzeto ${apiEvents.length} mečeva.`;
                apiStatus.classList.add('text-green-600');

            } catch (error) {
                console.error('API Fetch Error:', error);
                apiStatus.textContent = `Greška: ${error.message}`;
                apiStatus.classList.add('text-red-600');
            } finally {
                apiBtnText.textContent = 'Učitaj Mečeve sa API-ja';
                fetchApiBtn.disabled = false;
            }
        });

        on(competitionSelect, 'change', () => {
            const selectedCompetition = competitionSelect.value;
            const filteredEvents = apiEvents.filter(e => e.competition.name === selectedCompetition);
            eventSelect.innerHTML = '<option value="">Izaberi meč</option>';
            filteredEvents.forEach(e => {
                const option = document.createElement('option');
                option.value = e.id;
                option.textContent = `${e.home_team} vs ${e.away_team}`;
                eventSelect.appendChild(option);
            });
            eventSelect.disabled = false;
            teamSelect.disabled = true;
            playerSelect.disabled = true;
        });

        on(eventSelect, 'change', () => {
            const selectedEvent = apiEvents.find(e => e.id === eventSelect.value);
            if (!selectedEvent) {
                teamSelect.innerHTML = '';
                teamSelect.disabled = true;
                return;
            }
            
            $('#match-name').value = `${selectedEvent.home_team} - ${selectedEvent.away_team}`;
            const eventDate = new Date(selectedEvent.commence_time);
            $('#kickoff-date').value = eventDate.toISOString().split('T')[0];
            $('#kickoff-time').value = get24hTime(eventDate);

            teamSelect.innerHTML = '<option value="">Izaberi tim</option>';
            const homeTeamOption = document.createElement('option');
            homeTeamOption.value = selectedEvent.home_team;
            homeTeamOption.textContent = selectedEvent.home_team;
            teamSelect.appendChild(homeTeamOption);

            const awayTeamOption = document.createElement('option');
            awayTeamOption.value = selectedEvent.away_team;
            awayTeamOption.textContent = selectedEvent.away_team;
            teamSelect.appendChild(awayTeamOption);
            
            teamSelect.disabled = false;
        });

        on(teamSelect, 'change', () => {
            const selectedTeamName = teamSelect.value;
            const selectedEvent = apiEvents.find(e => e.id === eventSelect.value);
            if (!selectedEvent || !selectedEvent.bookmakers || !selectedEvent.bookmakers.length > 0) {
                playerSelect.innerHTML = '';
                playerSelect.disabled = true;
                addApiPlayerBtn.disabled = true;
                return;
            };

            const goalscorerMarket = selectedEvent.bookmakers[0].markets.find(m => m.key === 'player_anytime_goalscorer');
            if (!goalscorerMarket) {
                playerSelect.innerHTML = '<option value="">Nema podataka o igračima</option>';
                playerSelect.disabled = true;
                addApiPlayerBtn.disabled = true;
                return;
            }

            const homeTeamPlayers = goalscorerMarket.outcomes
                .filter(o => o.name.startsWith(selectedEvent.home_team))
                .map(o => ({ name: parsePlayerNameFromOutcome(o.name) }));
            
            const awayTeamPlayers = goalscorerMarket.outcomes
                .filter(o => o.name.startsWith(selectedEvent.away_team))
                .map(o => ({ name: parsePlayerNameFromOutcome(o.name) }));

            if (selectedTeamName === selectedEvent.home_team) {
                populatePlayerSelect(homeTeamPlayers);
            } else if (selectedTeamName === selectedEvent.away_team) {
                populatePlayerSelect(awayTeamPlayers);
            } else {
                playerSelect.innerHTML = '';
                playerSelect.disabled = true;
                addApiPlayerBtn.disabled = true;
            }
        });

        on(playerSelect, 'change', () => {
            addApiPlayerBtn.disabled = !playerSelect.value;
        });

        on(addApiPlayerBtn, 'click', () => {
            const playerName = playerSelect.value;
            if (!playerName) return;

            const playerStats = allFbrefStats.find(p => p.Player === playerName);
            addPlayer({ name: playerName, ...playerStats });
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadFbrefDb();
            addPlayer();
        });
    </script>
</body>
</html>
